{% extends "layout.html" %}
{% block content %}
<section>
    <button id="login" disabled onclick="login()">Log In With Passkey</button>
</section>
{% endblock %}

{% block tail %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', (event) => {
        if (!window.PublicKeyCredential || !PublicKeyCredential.isConditionalMediationAvailable) {
            return;
        }

        Promise.all([
            PublicKeyCredential.isConditionalMediationAvailable(),
            PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()])
            .then((values) => {
                if (values.every(x => x === true)) {
                    document.getElementById('login').disabled = false;
                }
            });
    });

    function url_b64(s) {
        return s.replace(/_/g, '/').replace(/-/g, '+');
    }

    function atob_url(a) {
        return atob(url_b64(a));
    }

    async function login() {
        const startResp = await fetch('/login/start', {
            method: 'POST'
        }).catch((error) => { console.error(error) });

        if (!startResp.ok) {
            window.alert('Error starting passkey authentication.');
            return;
        }

        var challenge = await startResp.json()
            .catch((error) => { console.error(error) });
        challenge.publicKey.challenge = Uint8Array.from(atob_url(challenge.publicKey.challenge), c => c.charCodeAt(0));
        challenge.publicKey.allowCredentials.forEach(obj => {
            obj.id = Uint8Array.from(atob_url(obj.id), c => c.charCodeAt(0));
        });

        const assertion = await navigator.credentials.get(challenge).catch(error => console.log(error));
        if (!assertion) {
            window.alert('Error authentication with passkey.')
            return;
        }

        const auth = {
            'id': assertion.id,
            'rawId': assertion.id,
            'response': {
                'authenticatorData': btoa(String.fromCharCode(...new Uint8Array(assertion.response.authenticatorData))),
                'clientDataJSON': btoa(new TextDecoder().decode(assertion.response.clientDataJSON)),
                'signature': btoa(String.fromCharCode(...new Uint8Array(assertion.response.signature))),
                'userHandle': btoa(String.fromCharCode(...new Uint8Array(assertion.response.userHandle))),
            },
            'type': 'public-key',
        };

        const finishResp = await fetch('/login/finish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(auth),
        });

        if (finishResp.ok) {
            window.location.href = '/admin/new';
        } else {
            window.alert('Error finishing passkey authentication.');
        }
    }
</script>
{% endblock %}